{% extends "base.html" %}
{% block title %}Blog{% endblock %}

{% block content %}
  <h2>Blog Posts</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if posts %}
    {% for post in posts %}
      <article>
        <h3><a href="{{ url_for('view_post', post_id=post.id) }}">{{ post.title }}</a></h3>
        <p><small>By <a href="{{ url_for('user_profile', username=post.author_username) }}">{{ post.author_username }}</a> on {{ post.timestamp }}
          {% if post.last_edited %}
            (Edited: {{ post.last_edited }})
          {% endif %}
          | {{ post.likes }} like(s) | {{ post.shares.count() if post.shares else 0 }} Share(s) {# Display Share Count #}
          <br> {# Add a line break for better spacing of review info #}
          Average Rating:
            {% if post.review_count > 0 %}
                {{ "%.1f" | format(post.average_rating) }}/5 ({{ post.review_count }} review{% if post.review_count != 1 %}s{% endif %})
            {% else %}
                No reviews yet.
            {% endif %}
        </small></p>
        <p>{{ post.content[:200] }}...</p>
        {% if post.hashtags %}
            <p>
                {% for tag in post.hashtags.split(',') %}
                    {% set cleaned_tag = tag.strip() %}
                    {% if cleaned_tag %}
                        <a href="{{ url_for('view_hashtag_posts', tag=cleaned_tag) }}">#{{ cleaned_tag }}</a>
                    {% endif %}
                {% endfor %}
            </p>
        {% endif %}
        <p><a href="{{ url_for('view_post', post_id=post.id) }}">Read More</a>
        {% if session.logged_in and session.username == post.author_username %}
          <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn btn-sm btn-outline-secondary" style="margin-left: 10px;">Edit</a>
        {% endif %}
        {% if current_user.is_authenticated %}
          <form action="{{ url_for('bookmark_post', post_id=post.id) }}" method="POST" style="display: inline; margin-left: 10px;">
              <button type="submit" class="btn btn-sm {% if post.id in bookmarked_post_ids %}btn-primary{% else %}btn-outline-primary{% endif %}">
                  {% if post.id in bookmarked_post_ids %}
                      Unbookmark
                  {% else %}
                      Bookmark
                  {% endif %}
              </button>
          </form>
        {% endif %}
        {% if current_user.is_authenticated %}
          <form action="{{ url_for('share_post', post_id=post.id) }}" method="POST" style="display: inline; margin-left: 10px;">
              <button type="submit" class="btn btn-sm btn-outline-success">Share</button> {# Simple Share Button #}
          </form>
        {% endif %}
        </p>
      </article>
      <hr>
    {% endfor %}
  {% else %}
    <p>No blog posts yet. <a href="{{ url_for('create_post') }}">Create one?</a></p>
  {% endif %}
{% endblock %}
