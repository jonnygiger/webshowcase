{% extends "base.html" %}

{% block title %}Real-Time Chat{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
    .chat-container {
        display: flex;
        height: calc(100vh - 120px); /* Adjust based on your header/footer height */
        border: 1px solid #ccc;
        border-radius: 5px;
        overflow: hidden;
    }

    .chat-sidebar {
        width: 25%;
        border-right: 1px solid #ccc;
        padding: 15px;
        background-color: #f9f9f9;
        overflow-y: auto;
    }

    .chat-main {
        width: 75%;
        display: flex;
        flex-direction: column;
    }

    .chat-room-header {
        padding: 15px;
        border-bottom: 1px solid #ccc;
        background-color: #f1f1f1;
    }

    .chat-room-header h3 {
        margin: 0;
    }

    .messages-area {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column-reverse; /* New messages at the bottom */
    }

    .message-input-area {
        padding: 15px;
        border-top: 1px solid #ccc;
        background-color: #f1f1f1;
    }

    .message-input-area form {
        display: flex;
    }

    .message-input-area input[type="text"] {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 3px;
        margin-right: 10px;
    }

    .message-input-area button {
        padding: 10px 15px;
    }

    .room-list-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .room-list-item:hover, .room-list-item.active {
        background-color: #e9e9e9;
    }
    .room-list-item small {
        font-size: 0.8em;
        color: #777;
    }

    .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 70%;
        word-wrap: break-word;
    }

    .message.sent {
        background-color: #dcf8c6;
        align-self: flex-end;
        margin-left: auto; /* Push to the right */
    }

    .message.received {
        background-color: #f0f0f0;
        align-self: flex-start;
        margin-right: auto; /* Push to the left */
    }

    .message .username {
        font-weight: bold;
        font-size: 0.9em;
        color: #555;
        display: block;
        margin-bottom: 3px;
    }
    .message .timestamp {
        font-size: 0.75em;
        color: #888;
        display: block;
        margin-top: 2px;
        text-align: right;
    }
    .system-message {
        text-align: center;
        color: #888;
        font-style: italic;
        font-size: 0.9em;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Real-Time Chat</h2>

    <div class="chat-container mt-3">
        <div class="chat-sidebar">
            <h4>Chat Rooms</h4>
            <button id="createRoomBtn" class="btn btn-sm btn-primary mb-2">Create Room</button>
            <div id="chatRoomList">
                <!-- Chat rooms will be loaded here by JavaScript -->
                <p>Loading rooms...</p>
            </div>
        </div>
        <div class="chat-main">
            <div class="chat-room-header">
                <h3 id="currentRoomName">Select a room</h3>
            </div>
            <div class="messages-area" id="messagesArea">
                <!-- Messages will be loaded here -->
                <p class="text-center" id="chatPlaceholder">Please select a room to start chatting or create a new one.</p>
            </div>
            <div class="message-input-area">
                <form id="messageForm" class="d-none"> {# Initially hidden #}
                    <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." autocomplete="off">
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Create Room Modal (optional, or simple prompt) -->
<div class="modal fade" id="createRoomModal" tabindex="-1" aria-labelledby="createRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createRoomModalLabel">Create New Chat Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createRoomForm">
                    <div class="mb-3">
                        <label for="newRoomNameInput" class="form-label">Room Name</label>
                        <input type="text" class="form-control" id="newRoomNameInput" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Room</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    // Ensure current_user is available and has an ID for API calls.
    const currentUserId = {{ current_user.id if current_user else 'null' }};
    const currentUsername = "{{ current_user.username if current_user else 'Anonymous' }}";
    let activeRoomName = null; // e.g., "chat_room_123"
    let activeRoomId = null; // e.g., 123

    // Initialize Socket.IO connection
    const socket = io(); // Connects to the server that served the page

    socket.on('connect', () => {
        console.log('Connected to Socket.IO server');
        // If rejoining a room is needed on reconnect, handle here
        if (activeRoomName) {
            socket.emit('join_chat_room', { room_name: activeRoomName });
        }
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from Socket.IO server');
    });

    socket.on('chat_error', (data) => {
        console.error('Chat Error:', data.message);
        alert(`Chat Error: ${data.message}`); // Simple alert for user feedback
    });

    // Listen for new messages
    socket.on('new_chat_message', (data) => {
        if (data.room_name === activeRoomName) {
            appendMessage(data, data.user_id === currentUserId);
        }
        // Potentially update unread count for other rooms if UI supports it
    });

    // Listen for users joining
    socket.on('user_joined_chat', (data) => {
        if (data.room === activeRoomName) {
            appendSystemMessage(`${data.username} has joined the room.`);
        }
    });

    // Listen for users leaving
    socket.on('user_left_chat', (data) => {
        if (data.room === activeRoomName) {
            appendSystemMessage(`${data.username} has left the room.`);
        }
    });

    function appendSystemMessage(message) {
        const messagesArea = document.getElementById('messagesArea');
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('system-message');
        msgDiv.textContent = message;
        messagesArea.prepend(msgDiv); // Prepend to keep new messages at the bottom (due to flex-direction: column-reverse)
    }


    // Function to fetch and display chat rooms
    async function fetchChatRooms() {
        try {
            const response = await fetch('/api/chat/rooms', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}` // Assuming JWT token is stored
                }
            });
            if (!response.ok) {
                throw new Error(`Failed to fetch chat rooms: ${response.statusText}`);
            }
            const data = await response.json();
            const roomListDiv = document.getElementById('chatRoomList');
            roomListDiv.innerHTML = ''; // Clear current list

            if (data.chat_rooms && data.chat_rooms.length > 0) {
                data.chat_rooms.forEach(room => {
                    const roomDiv = document.createElement('div');
                    roomDiv.classList.add('room-list-item');
                    roomDiv.textContent = room.name;
                    roomDiv.dataset.roomId = room.id;
                    roomDiv.dataset.roomName = `chat_room_${room.id}`; // Construct consistent room name for SocketIO

                    const creatorSpan = document.createElement('small');
                    creatorSpan.textContent = ` (Creator: ${room.creator_username || 'System'})`;
                    roomDiv.appendChild(creatorSpan);

                    roomDiv.onclick = () => selectRoom(room.id, room.name, `chat_room_${room.id}`);
                    roomListDiv.appendChild(roomDiv);
                });
            } else {
                roomListDiv.innerHTML = '<p>No chat rooms available. Create one!</p>';
            }
        } catch (error) {
            console.error('Error fetching chat rooms:', error);
            document.getElementById('chatRoomList').innerHTML = '<p>Error loading rooms.</p>';
        }
    }

    // Function to select a room and load its messages
    async function selectRoom(roomId, roomDisplayName, socketRoomName) {
        if (activeRoomName && activeRoomName !== socketRoomName) {
            socket.emit('leave_chat_room', { room_name: activeRoomName });
        }

        activeRoomId = roomId;
        activeRoomName = socketRoomName; // This is the SocketIO room identifier like "chat_room_1"
        document.getElementById('currentRoomName').textContent = roomDisplayName;
        document.getElementById('messagesArea').innerHTML = ''; // Clear messages
        document.getElementById('chatPlaceholder').style.display = 'none';
        document.getElementById('messageForm').classList.remove('d-none');


        // Highlight active room
        document.querySelectorAll('.room-list-item').forEach(item => item.classList.remove('active'));
        const selectedRoomItem = document.querySelector(`.room-list-item[data-room-id='${roomId}']`);
        if (selectedRoomItem) {
            selectedRoomItem.classList.add('active');
        }

        socket.emit('join_chat_room', { room_name: activeRoomName });

        try {
            const response = await fetch(`/api/chat/rooms/${roomId}/messages`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });
            if (!response.ok) {
                throw new Error(`Failed to fetch messages: ${response.statusText}`);
            }
            const data = await response.json();
            data.messages.forEach(msg => appendMessage(msg, msg.user_id === currentUserId));
        } catch (error) {
            console.error('Error fetching messages for room', roomId, ':', error);
            appendSystemMessage(`Error loading messages for ${roomDisplayName}.`);
        }
    }

    // Function to append a message to the messages area
    function appendMessage(msgData, isSentByCurrentUser) {
        const messagesArea = document.getElementById('messagesArea');
        // Remove placeholder if it exists
        const placeholder = document.getElementById('chatPlaceholder');
        if (placeholder) placeholder.style.display = 'none';

        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', isSentByCurrentUser ? 'sent' : 'received');

        const usernameSpan = document.createElement('span');
        usernameSpan.classList.add('username');
        usernameSpan.textContent = msgData.username || 'Unknown User'; // Fallback for username

        const contentP = document.createElement('p');
        contentP.textContent = msgData.message;

        const timestampSpan = document.createElement('span');
        timestampSpan.classList.add('timestamp');
        timestampSpan.textContent = new Date(msgData.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        msgDiv.appendChild(usernameSpan);
        msgDiv.appendChild(contentP);
        msgDiv.appendChild(timestampSpan);

        // messagesArea is flex-direction: column-reverse, so prepend to add to bottom
        messagesArea.prepend(msgDiv);
    }

    // Handle message form submission
    document.getElementById('messageForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const messageInput = document.getElementById('messageInput');
        const messageText = messageInput.value.trim();

        if (messageText && activeRoomName) {
            socket.emit('send_chat_message', {
                room_name: activeRoomName,
                message: messageText
            });
            messageInput.value = ''; // Clear input
        }
    });

    // Handle create room button and form submission
    document.getElementById('createRoomBtn').addEventListener('click', () => {
        // Using Bootstrap's Modal
        var createRoomModal = new bootstrap.Modal(document.getElementById('createRoomModal'));
        createRoomModal.show();
    });

    document.getElementById('createRoomForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newRoomNameInput = document.getElementById('newRoomNameInput');
        const newRoomName = newRoomNameInput.value.trim();

        if (newRoomName) {
            try {
                const response = await fetch('/api/chat/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({ name: newRoomName })
                });
                const result = await response.json();
                if (response.ok) {
                    fetchChatRooms(); // Refresh room list
                    newRoomNameInput.value = '';
                    var createRoomModalEl = document.getElementById('createRoomModal');
                    var modal = bootstrap.Modal.getInstance(createRoomModalEl);
                    modal.hide();
                    // Optionally, auto-select the new room
                    if (result.chat_room) {
                        selectRoom(result.chat_room.id, result.chat_room.name, `chat_room_${result.chat_room.id}`);
                    }
                } else {
                    alert(`Error creating room: ${result.message}`);
                }
            } catch (error) {
                console.error('Error creating room:', error);
                alert('Failed to create room. See console for details.');
            }
        }
    });


    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        if (!currentUserId) {
            // Handle case where user is not logged in or token is not available
            // For now, assume JWT token is fetched and stored by login logic
            // Or redirect to login if no token.
            // This example proceeds assuming token will be available for API calls.
            console.warn("User not logged in or access token not available. Chat functionality may be limited.");
            // Potentially disable chat features or prompt login
            document.getElementById('chatRoomList').innerHTML = '<p>Please log in to use chat.</p>';
            document.getElementById('createRoomBtn').disabled = true;
            return;
        }
        fetchChatRooms();
    });

</script>
{% endblock %}
