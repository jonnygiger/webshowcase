{% extends "base.html" %}

{% block title %}{{ group.name }} - Group Details{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h2>{{ group.name }}</h2>
        </div>
        <div class="card-body">
            <p class="card-text"><strong>Description:</strong> {{ group.description if group.description else 'No description provided.' }}</p>
            <p class="card-text"><small class="text-muted">Created by: {{ group.creator.username }} on {{ group.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small></p>

            <hr>
            <h4>Members ({{ group.members.count() }})</h4>
            {% if group.members.count() > 0 %}
                <ul class="list-group">
                    {% for member in group.members %}
                        <li class="list-group-item"><a href="{{ url_for('user_profile', username=member.username) }}">{{ member.username }}</a></li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>This group has no members yet.</p>
            {% endif %}

            <hr>
            <!-- Membership actions -->
            <div id="membership-actions" class="mt-3">
                {% if session.logged_in %}
                    {% if current_user_is_member %}
                        <form method="POST" action="{{ url_for('leave_group', group_id=group.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-danger">Leave Group</button>
                        </form>
                    {% elif group.creator_id == session.user_id %}
                         <p><span class="badge bg-info">You are the creator of this group.</span></p>
                    {% else %}
                        <form method="POST" action="{{ url_for('join_group', group_id=group.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-success">Join Group</button>
                        </form>
                    {% endif %}
                {% else %}
                    <p><a href="{{ url_for('login', next=request.url) }}">Log in</a> to join this group.</p>
                {% endif %}
            </div>

            <hr>
            <h4>Group Chat</h4>
            <div id="chat-messages" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background-color: #f9f9f9;">
                {% if chat_messages %}
                    {% for message in chat_messages %}
                        <div class="mb-2"> {# Using same class as JS for consistency #}
                            <small class="text-muted">{{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small><br>
                            <strong>{{ message.author.username }}</strong>: {{ message.content }}
                        </div>
                    {% endfor %}
                {% else %}
                    <p id="no-messages-yet" class="text-muted text-center">No messages yet. Start the conversation!</p>
                {% endif %}
            </div>
            <div class="input-group mb-3">
                <input type="text" id="chat-message-input" class="form-control" placeholder="Type your message...">
                <button id="send-chat-message-button" class="btn btn-primary">Send</button>
            </div>

        </div>
        <div class="card-footer">
            <a href="{{ url_for('groups_list') }}" class="btn btn-secondary">Back to Groups List</a>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const socket = io();
        const currentGroupId = {{ group.id }};
        const chatMessagesDiv = document.getElementById('chat-messages');
        const messageInput = document.getElementById('chat-message-input');
        const sendButton = document.getElementById('send-chat-message-button');

        // Get current username from session if available (for client-side display if needed)
        // This is primarily for display consistency if the server uses session.username
        const currentUsername = "{{ session.username if session.username else 'Anonymous' }}";

        // Emit join_group_chat on connection
        socket.on('connect', function() {
            console.log('Socket connected, joining group chat for group ID:', currentGroupId);
            socket.emit('join_group_chat', { group_id: currentGroupId });
        });

        // Scroll chat to bottom on initial load (after history is rendered)
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

        // Handle sending a message
        sendButton.addEventListener('click', function () {
            const messageContent = messageInput.value.trim();
            if (messageContent) {
                socket.emit('send_group_message', {
                    group_id: currentGroupId,
                    message_content: messageContent
                });
                messageInput.value = '';
            }
        });

        // Also allow sending message with Enter key
        messageInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendButton.click();
            }
        });

        // Handle receiving a message
        socket.on('receive_group_message', function (data) {
            // Ensure message is for the current group (though server-side room logic should handle this)
            if (data.group_id === currentGroupId) {
                // Remove "No messages yet" placeholder if it exists
                const noMessagesPlaceholder = document.getElementById('no-messages-yet');
                if (noMessagesPlaceholder) {
                    noMessagesPlaceholder.remove();
                }

                const messageElement = document.createElement('div');
                messageElement.classList.add('mb-2'); // Add some margin

                // Simple formatting: Sender (Timestamp): Message
                // Highlight if message is from current user (optional, needs current_user_id in JS)
                // For now, just display consistently.
                const timestamp = new Date(data.timestamp + 'Z').toLocaleString(); // Assuming UTC from server, 'Z' ensures correct parsing

                messageElement.innerHTML = `
                    <small class="text-muted">${timestamp}</small><br>
                    <strong>${data.sender_username}</strong>: ${data.message_content}
                `;
                chatMessagesDiv.appendChild(messageElement);
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
            }
        });

        // Handle potential errors from the server
        socket.on('error_event', function(data) {
            console.error('Socket Error:', data.message);
            alert('Chat Error: ' + data.message); // Simple alert for user
        });

        // For debugging connection issues
        socket.on('disconnect', function(reason) {
            console.log('Socket disconnected:', reason);
            // Optionally, inform the user or try to reconnect
        });

        socket.on('connect_error', (error) => {
            console.error('Socket connection error:', error);
        });

    });
</script>
{% endblock %}
