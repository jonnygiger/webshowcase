{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if post %}
    <h2>{{ post.title }}</h2>
    <p><small>By <a href="{{ url_for('user_profile', username=post.author_username) }}">{{ post.author_username }}</a> on {{ post.timestamp }}</small></p>
    <p>{{ post.content | safe }}</p> {# Assuming content is safe or will be sanitized later #}

    <div style="margin-top: 15px; margin-bottom: 15px;">
        <p>{{ post.likes }} like(s)</p>
        {% if session.logged_in %}
            {% if user_has_liked %}
                <form action="{{ url_for('unlike_post', post_id=post.id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-secondary btn-sm">Unlike</button>
                </form>
            {% else %}
                <form action="{{ url_for('like_post', post_id=post.id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-primary btn-sm">Like</button>
                </form>
            {% endif %}
        {% endif %}
    </div>

    {# Bookmark Button #}
    {% if current_user.is_authenticated %}
    <div style="margin-top: 15px; margin-bottom: 15px;">
        <form action="{{ url_for('bookmark_post', post_id=post.id) }}" method="POST" style="display: inline;">
            <button type="submit" class="btn {% if user_has_bookmarked %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                {% if user_has_bookmarked %}
                    Unbookmark
                {% else %}
                    Bookmark
                {% endif %}
            </button>
        </form>
    </div>
    {% endif %}

    {# Reaction Buttons and Counts #}
    <div style="margin-top: 15px; margin-bottom: 15px;">
        {% if current_user.is_authenticated %}
            {% set user_reacted_emoji = namespace(value=None) %}
            {% for r in reactions if r.user_id == current_user.id %}
                {% set user_reacted_emoji.value = r.emoji %}
            {% endfor %}

            <form action="{{ url_for('react_to_post', post_id=post.id) }}" method="POST" style="display: inline-block; margin-right: 10px;">
                {% for emoji_choice in ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'ü§î'] %}
                    <button type="submit" name="emoji" value="{{ emoji_choice }}"
                            class="btn btn-sm {% if emoji_choice == user_reacted_emoji.value %}btn-primary{% else %}btn-outline-secondary{% endif %}"
                            title="React with {{ emoji_choice }}">
                        {{ emoji_choice }}
                    </button>
                {% endfor %}
            </form>
        {% else %}
            <p><a href="{{ url_for('login') }}">Log in</a> to react.</p>
        {% endif %}

        <div style="margin-top: 10px;">
            {% if reaction_counts %}
                <strong>Reactions:</strong>
                {% for emoji_char, count in reaction_counts.items() %}
                    <span style="margin-right: 8px;" title="{{ count }} reaction{{ 's' if count != 1 else '' }} with {{ emoji_char }}">{{ emoji_char }} ({{ count }})</span>
                {% endfor %}
            {% else %}
                <small>No reactions yet.</small>
            {% endif %}
        </div>
    </div>

    {# Display Average Rating #}
    <div style="margin-top: 20px; margin-bottom: 20px;">
        <h4>
            Average Rating:
            {% if post_reviews|length > 0 %}
                {{ "%.1f" | format(average_rating) }}/5
                <small>(from {{ post_reviews|length }} review{% if post_reviews|length != 1 %}s{% endif %})</small>
            {% else %}
                No reviews yet.
            {% endif %}
        </h4>
    </div>

    {% if session.logged_in and session.username == post.author_username %}
    <hr>
    <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn btn-secondary" style="margin-top: 10px; margin-right: 5px;">Edit Post</a>
    <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" style="display: inline-block; margin-top: 10px;" onsubmit="return confirm('Are you sure you want to delete this post?');">
        <button type="submit" class="btn btn-danger">Delete Post</button>
    </form>
    {% endif %}

    <hr style="margin-top: 30px; margin-bottom: 30px;">

    {# Review Submission Form #}
    {% if can_submit_review %}
        <h3>Submit Your Review</h3>
        <form method="POST" action="{{ url_for('add_review', post_id=post.id) }}">
            <div class="form-group" style="margin-bottom: 10px;">
                <label for="rating">Rating (1-5):</label>
                <select class="form-control" id="rating" name="rating" required>
                    <option value="5">5 Stars (Excellent)</option>
                    <option value="4">4 Stars (Good)</option>
                    <option value="3">3 Stars (Average)</option>
                    <option value="2">2 Stars (Poor)</option>
                    <option value="1">1 Star (Terrible)</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 10px;">
                <label for="review_text">Your Review:</label>
                <textarea class="form-control" id="review_text" name="review_text" rows="3" required></textarea>
            </div>
            <div style="margin-bottom: 20px;">
                <button type="submit" class="btn btn-primary">Submit Review</button>
            </div>
        </form>
        <hr style="margin-top: 30px; margin-bottom: 30px;">
    {% endif %}

    {# Display Existing Reviews #}
    <h3>Reviews</h3>
    <div id="reviews-section">
        {% if post_reviews and post_reviews|length > 0 %}
            {% for review in post_reviews %}
                <div class="review" style="margin-bottom: 15px; padding: 10px; border: 1px solid #eee;">
                    <p>
                        <strong><a href="{{ url_for('user_profile', username=review.reviewer_username) }}">{{ review.reviewer_username }}</a></strong>
                        rated: <strong>{{ review.rating }}/5 stars</strong>
                        <small class="text-muted">({{ review.timestamp }})</small>
                    </p>
                    <p style="white-space: pre-wrap;">{{ review.review_text }}</p>
                </div>
            {% endfor %}
        {% else %}
            <p id="no-reviews-message">
                {% if not can_submit_review and not (session.logged_in and session.username == post.author_username) %}
                    No reviews yet for this post.
                {% elif session.logged_in and session.username == post.author_username %}
                    Your post has no reviews yet.
                {% elif not session.logged_in %}
                     No reviews yet. <a href="{{ url_for('login') }}">Log in</a> to submit one.
                {% endif %}
                {# If can_submit_review is true, the form is shown, so no message needed here for that case #}
            </p>
        {% endif %}
    </div>

    <hr style="margin-top: 30px; margin-bottom: 30px;">

    {# Comment Submission Form #}
    {% if session['logged_in'] %}
        <h3>Add a Comment</h3>
        <form method="POST" action="{{ url_for('add_comment', post_id=post.id) }}">
            <div class="form-group" style="margin-bottom: 10px;">
                <label for="comment_content">Your Comment:</label>
                <textarea class="form-control" name="comment_content" id="comment_content" rows="3" required></textarea>
            </div>
            <div style="margin-bottom: 20px;">
                <button type="submit" class="btn btn-primary">Add Comment</button>
            </div>
        </form>
    {% else %}
        <p><a href="{{ url_for('login') }}">Log in</a> to add a comment.</p>
    {% endif %}

    {# Display Comments #}
    <h3>Comments</h3>
    <div id="comments-section">
        {% if comments and comments|length > 0 %}
            {% for comment in comments %}
                <div class="comment" style="margin-bottom: 15px; padding: 10px; border: 1px solid #eee;">
                    <p><strong><a href="{{ url_for('user_profile', username=comment.author_username) }}">{{ comment.author_username }}</a></strong> <small class="text-muted">({{ comment.timestamp }})</small></p>
                    <p style="white-space: pre-wrap;">{{ comment.content }}</p>
                </div>
            {% endfor %}
        {% else %}
            <p id="no-comments-message">No comments yet. Be the first to comment!</p>
        {% endif %}
    </div>

    <hr style="margin-top: 20px;"> {# Add some space before the general back button #}
    <a href="{{ url_for('blog') }}" class="btn btn-info">Back to Blog</a>
  {% else %}
    {# This case should ideally be handled by the route redirecting, but as a fallback: #}
    <p>Post not found.</p>
    <a href="{{ url_for('blog') }}" class="btn btn-secondary">Back to Blog</a>
  {% endif %}
{% endblock %}

{% block scripts %}
{{ super() }} {# Include scripts from base template if any #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', (event) => {
    // Connect to SocketIO server
    var socket = io();

    // Get post_id from the page
    var postId = {{ post.id if post else 'null' }}; // Ensure post.id is available
    if (!postId) return; // Do not proceed if postId is not available

    var room = 'post_' + postId;

    // Emit an event to join the room for this specific post
    socket.emit('join_room', {room: room});

    // Listen for the 'new_comment_event'
    socket.on('new_comment_event', function(comment) {
      if (comment.post_id === postId) {
        var commentsSection = document.getElementById('comments-section');
        // Ensure commentsSection exists
        if (!commentsSection) {
            // Attempt to find where to inject comments section if it's missing
            var reviewSection = document.getElementById('reviews-section');
            if (reviewSection) {
                commentsSection = document.createElement('div');
                commentsSection.id = 'comments-section';
                var commentsHeader = document.createElement('h3');
                commentsHeader.textContent = 'Comments';
                reviewSection.parentNode.insertBefore(commentsHeader, reviewSection.nextSibling);
                reviewSection.parentNode.insertBefore(commentsSection, commentsHeader.nextSibling);
            } else {
                console.error("Could not find comments section or suitable anchor to create it.");
                return;
            }
        }


        // Create the new comment element
        var commentDiv = document.createElement('div');
        commentDiv.classList.add('comment'); // Add a class for styling if needed
        commentDiv.style.marginBottom = '15px';
        commentDiv.style.padding = '10px';
        commentDiv.style.border = '1px solid #eee';

        var authorLink = document.createElement('a');
        authorLink.href = "/user/" + comment.author_username; // Simplified URL generation
        authorLink.textContent = comment.author_username;

        var commentAuthorStrong = document.createElement('strong');
        commentAuthorStrong.appendChild(authorLink);

        var commentTimestamp = document.createElement('small');
        commentTimestamp.classList.add('text-muted');
        var date = new Date(comment.timestamp.replace(' ', 'T') + 'Z');
        commentTimestamp.textContent = ' (' + date.toLocaleString() + ')';


        var commentContent = document.createElement('p');
        commentContent.style.whiteSpace = 'pre-wrap';
        commentContent.textContent = comment.content;

        var pAuthor = document.createElement('p');
        pAuthor.appendChild(commentAuthorStrong);
        pAuthor.appendChild(document.createTextNode(' ')); // Add space
        pAuthor.appendChild(commentTimestamp);

        commentDiv.appendChild(pAuthor);
        commentDiv.appendChild(commentContent);

        // Prepend or append based on desired order (newest first or last)
        // Assuming newest comments might go on top, or sort on server and always append
        var firstChild = commentsSection.firstChild;
        if (firstChild && firstChild.id === 'no-comments-message'){
            firstChild.remove(); // Remove "No comments" message
            commentsSection.appendChild(commentDiv); // Append if it was the only thing
        } else if (firstChild) {
            commentsSection.insertBefore(commentDiv, firstChild); // Prepend to existing comments
        } else {
           commentsSection.appendChild(commentDiv); // Append if section was empty but no message
        }


        // Optional: If there's a "No comments yet" message, remove it
        var noCommentsMessage = document.getElementById('no-comments-message');
        if (noCommentsMessage) {
          noCommentsMessage.style.display = 'none'; // Hide or remove
        }
      }
    });
  });
</script>
{% endblock %}
