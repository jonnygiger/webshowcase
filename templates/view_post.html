{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if post %}
    <h2>{{ post.title }}</h2>
    <p><small>By {{ post.author_username }} on {{ post.timestamp }}</small></p>
    <p>{{ post.content | safe }}</p> {# Assuming content is safe or will be sanitized later #}

    {% if session.logged_in and session.username == post.author_username %}
    <hr>
    <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn btn-secondary" style="margin-top: 10px; margin-right: 5px;">Edit Post</a>
    <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" style="display: inline-block; margin-top: 10px;" onsubmit="return confirm('Are you sure you want to delete this post?');">
        <button type="submit" class="btn btn-danger">Delete Post</button>
    </form>
    {% endif %}

    <hr style="margin-top: 30px; margin-bottom: 30px;">

    {# Comment Submission Form #}
    {% if session['logged_in'] %}
        <h3>Add a Comment</h3>
        <form method="POST" action="{{ url_for('add_comment', post_id=post.id) }}">
            <div class="form-group" style="margin-bottom: 10px;">
                <label for="comment_content">Your Comment:</label>
                <textarea class="form-control" name="comment_content" id="comment_content" rows="3" required></textarea>
            </div>
            <div style="margin-bottom: 20px;">
                <button type="submit" class="btn btn-primary">Add Comment</button>
            </div>
        </form>
    {% else %}
        <p><a href="{{ url_for('login') }}">Log in</a> to add a comment.</p>
    {% endif %}

    {# Display Comments #}
    <h3>Comments</h3>
    {% if comments and comments|length > 0 %}
        {% for comment in comments %}
            <div class="comment" style="margin-bottom: 15px; padding: 10px; border: 1px solid #eee;">
                <p><strong>{{ comment.author_username }}</strong> <small class="text-muted">({{ comment.timestamp }})</small></p>
                <p style="white-space: pre-wrap;">{{ comment.content }}</p>
            </div>
        {% endfor %}
    {% else %}
        <p>No comments yet. Be the first to comment!</p>
    {% endif %}

    <hr style="margin-top: 20px;"> {# Add some space before the general back button #}
    <a href="{{ url_for('blog') }}" class="btn btn-info">Back to Blog</a>
  {% else %}
    {# This case should ideally be handled by the route redirecting, but as a fallback: #}
    <p>Post not found.</p>
    <a href="{{ url_for('blog') }}" class="btn btn-secondary">Back to Blog</a>
  {% endif %}
{% endblock %}
